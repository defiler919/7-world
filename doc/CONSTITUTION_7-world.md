# 7-world 项目宪法清单（不可违反）

> 目的：防止项目后期跑偏。以后任何 DayX 的新增/修改，只要违反其中任意一条，就算“跑偏”。

---

## 0. 总目标
这是一个“桌面生态/摸鱼世界”的**慢变量系统**：玩家/相机在“浏览”，生态在“缓慢演化”。  
所有系统必须围绕：**可扩展、可插拔、可回放、可调参、可观测**。

---

## 1) 状态与行为分离

### 1.1 WorldState / LayerState 只做“快照”
- ✅ 只存数据（当前是什么样）
- ✅ 允许任何系统读取
- ❌ 禁止在 State 里写“如果……就……”的逻辑
- ❌ 禁止 State 驱动相机/生成/规则/输入

**判断标准**：State 文件里出现“决策/分支/玩法规则”，就是违宪。

### 1.2 行为只能在各自的 Controller / Root / Layer 内发生
- 世界级行为：`WorldRoot`（或类似中枢）
- 层内行为：Layer 自己的模块（Spawner/Visuals/Hazard…）

---

## 2) Intent → Inertia → Applied（慢变量管线不可破坏）

### 2.1 Intent 永远是“建议值”
- Intent 可以跳变、可以粗糙、可以是 AI 输出
- ❌ 不允许直接用 Intent 驱动最终效果（除非明确是 debug/瞬时展示）

### 2.2 Applied 永远是“执行值”
- Applied 只能来自惯性/平滑/限速后的结果
- 任何实体生成、死亡、视觉、污染、风险，都应优先读 `state.applied`

### 2.3 任何“快变化”都必须明确标注为例外
- 例外必须写在注释里，说明为什么不走惯性（如：debug闪烁、瞬时切层提示）

---

## 3) 模块黑盒化（可插拔）

### 3.1 模块不得依赖外部节点路径
- ✅ 模块只允许：
  - `get_parent()`（拿到 Layer）
  - 或通过 export 的 NodePath/引用（由场景注入）
- ❌ 禁止写死 `../..`、`/root/...`、跨层 `get_node("OtherLayer/...")`

### 3.2 模块输入必须是“只读接口”
- 例如：
  - 读 `layer.state.applied`
  - 读 `WorldState`（只读）
- ❌ 模块不得修改别的模块的内部状态

### 3.3 模块输出要么“行为结果”，要么“只读快照”
- 行为结果：spawn、queue_free、改颜色
- 只读快照：`get_population_state()` 这种

---

## 4) Debug 只观察，不推断、不控制

### 4.1 DebugOverlay 只能显示现成信息
- ✅ 显示 `WorldState` / `LayerState` / 模块快照
- ❌ 禁止 DebugOverlay 去“猜”：
  - 哪个是当前层
  - 节点顺序代表什么
  - group 里第几个就是谁

### 4.2 Debug 不参与任何决策链
- ❌ Debug 不得影响游戏世界（哪怕是“方便测试”）
- ❌ Debug 不得写回 state / intent / applied

---

## 5) 层级身份与顺序彻底解耦（反跑偏核心）

### 5.1 “层是谁”必须用稳定 ID 表达
- ✅ `current_layer_id`（StringName / String / int 常量都行，但必须稳定）
- ❌ 禁止用 `current_layer_index` 当身份

### 5.2 index 只允许表示“当前视角指针”
- index 可以变
- 可以重排
- 可以插入新层后整体偏移
- **存档/统计/规则都不能依赖 index**

### 5.3 任何需要“映射”的地方，必须通过映射表
- 例如：`layer_id -> Layer node`
- 例如：`layer_id -> 配置资源`

---

## 6) 可存档、可回放优先

### 6.1 存档保存“身份 + 关键状态”，不保存“引用/顺序”
- ✅ 保存：
  - `current_layer_id`
  - `current_col_index`
  - `world_time`
  - 每层必要的“生态状态快照”（后面再定）
- ❌ 不保存：
  - 节点路径
  - group 顺序
  - 内存引用

### 6.2 可回放要求：同一份存档应能在未来版本加载
- 所以：新增层/插入层不应破坏旧存档

---

## 7) 参数可调、可解释

### 7.1 所有关键常量必须 export 或集中配置
- tau、max_rate、risk->alpha映射、spawn倍率、death倍率…
- ❌ 禁止散落神秘数字且无注释

### 7.2 每个模块必须写清楚：
- 输入字段（读哪些 key）
- 输出行为（会生成/销毁/改颜色）
- 约束（上限、限速、防抖）

---

## 附录：快速“违宪自检”口诀
- **State 里出现 if/else 规则？** → 违宪  
- **DebugOverlay 在猜层是谁？** → 违宪  
- **模块跨层 get_node 找别人？** → 违宪  
- **用 index 当层身份写存档/规则？** → 违宪  
- **Intent 直接驱动生成/颜色？** → 违宪（除非明确例外并标注）  
