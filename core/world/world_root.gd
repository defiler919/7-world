# ============================================================
# æ¨¡å—å®ªæ³•ï¼šWorldRootï¼ˆä¸–ç•Œæ ¹èŠ‚ç‚¹ï¼‰
# ============================================================
#
# ã€è¿™ä¸ªæ¨¡å—æ˜¯ä»€ä¹ˆï¼Ÿã€‘
# WorldRoot æ˜¯â€œæ•´ä¸ªä¸–ç•Œçš„å…¥å£èŠ‚ç‚¹â€ï¼Œ
# å®ƒä¸æ˜¯æŸä¸€å±‚ã€æŸä¸ªç³»ç»Ÿï¼Œè€Œæ˜¯ï¼š
# ğŸ‘‰ æŠŠâ€œä¸–ç•Œâ€ç»„è£…èµ·æ¥çš„åœ°æ–¹ã€‚
#
# ä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºï¼š
# - ä¸–ç•Œçš„ã€è£…é…å°ã€‘
# - ä¸–ç•Œçš„ã€æ€»æ§ä¸­æ¢ã€‘
#
# ------------------------------------------------------------
# ã€å®ƒè´Ÿè´£ä»€ä¹ˆï¼Ÿã€‘
# 1. æ ¹æ® WorldConfigï¼š
#    - åŠ è½½æ¯ä¸€å±‚çš„åœºæ™¯
#    - å†³å®šæ¯ä¸€å±‚æ”¾åœ¨ä¸–ç•Œä¸­çš„ä»€ä¹ˆä½ç½®
#
# 2. æŒæœ‰â€œå½“å‰ä¸–ç•ŒçŠ¶æ€â€çš„å…¥å£ä¿¡æ¯ï¼š
#    - å½“å‰åœ¨å“ªä¸€å±‚
#    - ä¸–ç•Œé‡Œæœ‰å“ªäº›å±‚èŠ‚ç‚¹
#
# 3. å¯¹å¤–æä¾›â€œä¸–ç•Œçº§æ¥å£â€ï¼ˆä»¥åä¼šç”¨åˆ°ï¼‰ï¼š
#    - Debug / UI è¯»å–ä¸–ç•ŒçŠ¶æ€ï¼ˆWorldStateï¼‰
#
# ------------------------------------------------------------
# ã€å®ƒä¸è´Ÿè´£ä»€ä¹ˆï¼Ÿï¼ˆéå¸¸é‡è¦ï¼‰ã€‘
# âŒ ä¸å†™å…·ä½“ç”Ÿæ€è§„åˆ™ï¼ˆé±¼æ€ä¹ˆæ¸¸ã€æ¤ç‰©æ€ä¹ˆé•¿ï¼‰
# âŒ ä¸å†™ç¨€æœ‰äº‹ä»¶é€»è¾‘
# âŒ ä¸ç›´æ¥æ“ä½œ res://layers/ ä¸‹çš„å…·ä½“è„šæœ¬
#    ï¼ˆæ‰€æœ‰å±‚éƒ½å¿…é¡»æ˜¯â€œå¯æ›¿æ¢çš„é»‘ç›’â€ï¼‰
#
# å¦‚æœä»¥åä½ å‘ç°è‡ªå·±æƒ³åœ¨è¿™é‡Œå†™ï¼š
#   â€œå¦‚æœæ˜¯æµ…æµ·å°±æ€æ ·â€¦â€¦â€
# é‚£ä¸€å®šæ˜¯å†™é”™åœ°æ–¹äº†ã€‚
#
# ------------------------------------------------------------
# ã€è®¾è®¡åŸåˆ™ï¼ˆç»™æœªæ¥çš„ä½ çœ‹çš„ï¼‰ã€‘
# - WorldRoot åªå…³å¿ƒâ€œä¸–ç•Œç»“æ„â€ï¼Œä¸å…³å¿ƒâ€œä¸–ç•Œå†…å®¹â€
# - æ‰€æœ‰å±‚å¿…é¡»é€šè¿‡é…ç½®ï¼ˆWorldConfigï¼‰è¿›å…¥ä¸–ç•Œ
# - WorldRoot å¯ä»¥è¢«ç›¸æœºã€UIã€Debug æŸ¥è¯¢
#   ä½†ä¸ä¸»åŠ¨æ“æ§å®ƒä»¬
#
# ============================================================

extends Node

# ------------------------------------------------------------
# ä¾èµ–ï¼šWorldState è„šæœ¬ï¼ˆä¿å­˜â€œä¸–ç•Œå¿«ç…§â€çš„æ•°æ®å®¹å™¨ï¼‰
# ------------------------------------------------------------
# æ³¨æ„ï¼ˆæ–°æ‰‹é‡ç‚¹ï¼‰ï¼š
# - è¿™é‡Œ preload çš„æ˜¯ä¸€ä¸ªè„šæœ¬èµ„æºï¼ˆScriptï¼‰
# - ä½ åé¢ç”¨äº† `WorldStateRes.new()` æ¥åˆ›å»ºå®ä¾‹
# - è¿™è¦æ±‚ world_state.gd å†…éƒ¨è¦ä¹ˆå†™äº† `class_name WorldState`
#   è¦ä¹ˆä½ å°±åªç”¨è„šæœ¬å˜é‡æ‰¿æ¥å®ä¾‹ï¼Œä¸åšå¼ºç±»å‹å£°æ˜
const WorldStateRes := preload("res://core/world/world_state.gd")

# ------------------------------------------------------------
# å¯é€‰ï¼šæ—¶é’Ÿï¼ˆWorldClockï¼‰
# ------------------------------------------------------------
# clock_pathï¼šåœ¨åœºæ™¯æ ‘ä¸­æŒ‡å‘ WorldClock èŠ‚ç‚¹çš„è·¯å¾„
# å¦‚æœä½ ä¸éœ€è¦æ—¶é—´ç³»ç»Ÿï¼Œå¯ä»¥ä¸å¡«ï¼Œè¿™é‡Œä¼šæ‹¿åˆ° null
@export var clock_path: NodePath
var clock: WorldClock

# ------------------------------------------------------------
# ä¸–ç•Œé…ç½®ï¼ˆç”±ç¼–è¾‘å™¨æˆ–å¤–éƒ¨æ³¨å…¥ï¼‰
# ------------------------------------------------------------
# WorldConfig æè¿°çš„æ˜¯ï¼š
# - ä¸–ç•Œæœ‰å‡ å±‚
# - æ¯ä¸€å±‚ç”¨å“ªä¸ªåœºæ™¯
# - æ¯ä¸€å±‚åœ¨ä¸–ç•Œä¸­çš„ä½ç½®è§„åˆ™
#
# WorldRoot ä¸å…³å¿ƒâ€œé…ç½®æ˜¯æ€ä¹ˆæ¥çš„â€ï¼Œ
# åªå…³å¿ƒâ€œæˆ‘èƒ½ä¸èƒ½ç”¨å®ƒæ¥è£…é…ä¸–ç•Œâ€ã€‚
@export var config: WorldConfig

# ------------------------------------------------------------
# å½“å‰æ‰€åœ¨çš„å±‚ç´¢å¼•ï¼ˆé€»è¾‘å±‚ï¼‰
# ------------------------------------------------------------
# è¡¨ç¤ºâ€œå½“å‰å…³æ³¨/æ´»è·ƒå±‚â€
# æ³¨æ„ï¼šè¿™é‡Œæš‚æ—¶åªæ˜¯è®°å½•ï¼Œåˆ‡æ¢åŠ¨ä½œä¸»è¦ç”± CameraController åš
var current_layer_index: int = 0

# ------------------------------------------------------------
# å½“å‰å·²ç»åŠ è½½åˆ°ä¸–ç•Œä¸­çš„å±‚èŠ‚ç‚¹
# ------------------------------------------------------------
# layers æ˜¯è¿è¡Œæ—¶æ•°ç»„ï¼š
# - æ¯ä¸ªå…ƒç´ å¯¹åº”ä¸€ä¸ª Node2D å±‚å®ä¾‹
# - é¡ºåºå¿…é¡»å’Œ config.layer_scene_paths ä¸€è‡´
#
# WorldRoot ç”¨å®ƒæ¥ï¼š
# - ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼ˆæ¸…ç† / é‡å»ºï¼‰
# - æä¾›æœªæ¥çš„ä¸–ç•Œçº§æŸ¥è¯¢ï¼ˆæ¯”å¦‚ï¼šæ‹¿åˆ°æŸå±‚èŠ‚ç‚¹ï¼‰
var layers: Array[Node2D] = []

# ------------------------------------------------------------
# ä¸–ç•ŒçŠ¶æ€å¿«ç…§ï¼ˆDay2ï¼‰
# ------------------------------------------------------------
# state æ˜¯â€œåªè¯»å¿«ç…§â€ï¼š
# - ä¸åšå†³ç­–
# - ä¸å¤„ç†è¾“å…¥
# - åªè´Ÿè´£æŠŠå½“å‰ä¸–ç•Œçš„å…³é”®æ•°æ®æ±‡æ€»ï¼Œç»™ Debug/UI æŸ¥çœ‹
var state: WorldState = WorldStateRes.new()


@export var camera_controller_path: NodePath
var camera_controller: Node

# ------------------------------------------------------------
# ç”Ÿå‘½å‘¨æœŸï¼šä¸–ç•Œå‡†å¤‡å®Œæˆ
# ------------------------------------------------------------
func _ready() -> void:
	# å¦‚æœæ²¡æœ‰é…ç½®ï¼Œå…œåº•åˆ›å»ºä¸€ä¸ªé»˜è®¤é…ç½®ï¼ˆé˜²æ­¢å·¥ç¨‹ç›´æ¥æŠ¥é”™ï¼‰
	if config == null:
		config = WorldConfig.new()
	camera_controller = get_node_or_null(camera_controller_path)

	# å°è¯•ç»‘å®šæ—¶é’Ÿï¼ˆå¯èƒ½ä¸ºç©ºï¼‰
	clock = get_node_or_null(clock_path) as WorldClock

	# 1) æ ¹æ®é…ç½®ï¼ŒåŠ è½½å¹¶è£…é…æ‰€æœ‰å±‚
	_load_layers()

	# 2) ç«‹åˆ»ç”Ÿæˆä¸€æ¬¡ä¸–ç•ŒçŠ¶æ€ï¼Œä¿è¯ DebugOverlay ä¸€ä¸Šæ¥å°±æœ‰å€¼
	_update_world_state()

func _process(_delta: float) -> void:
	# æ¯å¸§æ›´æ–°ä¸–ç•ŒçŠ¶æ€ï¼ˆDay2 ç”¨äºè°ƒè¯•å¾ˆæ–¹ä¾¿ï¼‰
	# æœªæ¥å¦‚æœæ‹…å¿ƒæ€§èƒ½ï¼Œå¯ä»¥æ”¹ä¸ºâ€œæœ‰å˜åŒ–æ‰æ›´æ–°â€æˆ–é™ä½é¢‘ç‡
	_update_world_state()

# ------------------------------------------------------------
# å†…éƒ¨æ–¹æ³•ï¼šåŠ è½½æ‰€æœ‰å±‚åœºæ™¯
# ------------------------------------------------------------
# è¿™ä¸ªå‡½æ•°åªåšä¸€ä»¶äº‹ï¼š
# ğŸ‘‰ â€œæŠŠ WorldConfig æè¿°çš„å±‚ï¼ŒçœŸæ­£å®ä¾‹åŒ–åˆ°ä¸–ç•Œä¸­â€
#
# è¡Œä¸ºé¡ºåºï¼š
# 1. æ¸…ç†æ—§å±‚
# 2. è¯»å– layer_scene_paths
# 3. é€ä¸ª instantiate
# 4. æ”¾åˆ°æ­£ç¡®çš„ä¸–ç•Œåæ ‡
#
# æ³¨æ„ï¼š
# - è¿™é‡Œåªå‡è®¾â€œå±‚æ˜¯ Node2Dâ€
# - ä¸å…³å¿ƒå±‚é‡Œé¢æœ‰ä»€ä¹ˆï¼ˆå±‚æ˜¯é»‘ç›’ï¼‰
func _load_layers() -> void:
	# å…ˆæ¸…ç†æ—§çš„å±‚èŠ‚ç‚¹ï¼ˆé˜²æ­¢é‡å¤åŠ è½½ï¼‰
	for l in layers:
		if is_instance_valid(l):
			l.queue_free()
	layers.clear()

	# æ ¹æ®é…ç½®ä¸­å®šä¹‰çš„å±‚è·¯å¾„ï¼Œé€ä¸ªåŠ è½½
	for i in range(config.layer_scene_paths.size()):
		var path: String = config.layer_scene_paths[i]
		var scene: PackedScene = load(path)

		if scene == null:
			push_error("Layer scene not found: %s" % path)
			continue

		var inst: Node = scene.instantiate()

		# å¼ºåˆ¶è¦æ±‚ï¼šå±‚çš„æ ¹èŠ‚ç‚¹å¿…é¡»æ˜¯ Node2D
		# å› ä¸ºä½ æ•´ä¸ªä¸–ç•Œæ˜¯ 2D å¹³é¢æ‘†æ”¾ï¼ˆpositionï¼‰
		if inst is Node2D:
			var layer: Node2D = inst

			# æ ¹æ®é…ç½®ï¼Œè®¡ç®—è¯¥å±‚åœ¨ä¸–ç•Œä¸­çš„èµ·å§‹ä½ç½®ï¼ˆoriginï¼‰
			# ä¾‹å¦‚ï¼šlayer0 æ”¾ y=0ï¼Œlayer1 æ”¾ y=cell_height
			layer.position = config.get_layer_origin(i)

			# åŠ å…¥åˆ°ä¸–ç•Œæ ‘ä¸­
			add_child(layer)

			# è®°å½•ä¸‹æ¥ï¼Œä¾›ä¸–ç•Œç³»ç»Ÿä½¿ç”¨
			layers.append(layer)
		else:
			push_error("Layer root must be Node2D: %s" % path)
			inst.queue_free()

# ------------------------------------------------------------
# ä¸–ç•ŒçŠ¶æ€ï¼šæ›´æ–°å¿«ç…§ï¼ˆDay2ï¼‰
# ------------------------------------------------------------
# è¯´æ˜ï¼š
# - WorldRoot æ˜¯â€œä¸–ç•ŒçŠ¶æ€çš„å”¯ä¸€å‡ºå£â€ï¼Œæ‰€ä»¥ç”±å®ƒç»Ÿä¸€æ›´æ–° state
# - state ä¸åšå†³ç­–ï¼Œåªè®°å½•å½“å‰å€¼
# - DebugOverlay / UI ä¼šé€šè¿‡ get_world_state() è¯»å–å®ƒ
func _update_world_state() -> void:
	# å½“å‰å±‚ï¼ˆWorldRoot è®°å½•çš„ï¼‰
	state.current_layer_index = current_layer_index
	# ä¸–ç•Œæ—¶é—´ï¼šä» WorldClock è¯»å‡ºæ¥ï¼Œå†™è¿› WorldState
	if clock != null:
		state.world_time = clock.world_time
	else:
		state.world_time = 0.0
	# å½“å‰åˆ—ï¼ˆcolï¼‰
	# ä½ åœ¨ Day1/Day2 çš„è®¾è®¡é‡Œï¼Œcol_index åœ¨ CameraController é‡Œç»´æŠ¤ã€‚
	# è¿™é‡Œå…ˆå†™æ­» 0 æ˜¯å¯ä»¥è·‘çš„ï¼Œä½† Debug ä¼šæ°¸è¿œæ˜¾ç¤º 0ã€‚
	# âœ… åç»­ Day2 æˆ‘ä»¬ä¼šåšâ€œæ¡¥æ¥â€ï¼š
	# - è¦ä¹ˆæŠŠ col_index ä¹Ÿæå‡åˆ° WorldRoot
	# - è¦ä¹ˆç»™ CameraController ä¸€ä¸ªåªè¯» getter æ¥è¯»å‡ºæ¥
	state.current_col_index = 0

	# è§†å£å¤§å°ï¼ˆç”¨äº debug åˆ¤æ–­ clamp æ˜¯å¦åˆç†ï¼‰
	state.viewport_size = get_viewport().get_visible_rect().size

	# ç›¸æœºä¿¡æ¯ï¼šè¯»å½“å‰è§†å£çš„ active Camera2D
	# æ³¨æ„ï¼ˆæ–°æ‰‹é‡ç‚¹ï¼‰ï¼š
	# - get_camera_2d() å–çš„æ˜¯â€œå½“å‰ viewport æ­£åœ¨ä½¿ç”¨çš„ç›¸æœºâ€
	# - å¦‚æœæœªæ¥ä½ æœ‰å¤šä¸ª viewport / å­è§†å£ï¼Œè¿™é‡Œè¦æ›´æ˜ç¡®åœ°æŒ‡å®š
	var cam: Camera2D = get_viewport().get_camera_2d()
	if cam != null:
		state.camera_center = cam.global_position

	# --- é‡‡é›† CameraController çš„çŠ¶æ€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰---
	if camera_controller != null and camera_controller.has_method("get_camera_state_snapshot"):
		var snap: Dictionary = camera_controller.get_camera_state_snapshot()
		state.current_layer_index = int(snap["layer_index"])
		state.current_col_index = int(snap["col_index"])
		state.camera_local_offset = snap["local_offset"]
		state.switch_cooldown_left = float(snap["cooldown_left"])
	else:
		# æ²¡æ‰¾åˆ°å°±ç”¨å…œåº•
		state.current_layer_index = current_layer_index
		state.current_col_index = 0
		state.camera_local_offset = Vector2.ZERO
		state.switch_cooldown_left = 0.0



	# å†·å´å‰©ä½™æ—¶é—´ï¼š
	# ç›®å‰ CameraController çš„ _switch_cd_left æ˜¯â€œç§æœ‰å˜é‡â€ï¼ˆå‰ç¼€ _ï¼‰
	# æˆ‘ä»¬ä¸å¼ºè¡Œè¯»å®ƒï¼Œé¿å…ç ´åè¾¹ç•Œã€‚
	# âœ… åç»­å¦‚æœæƒ³æ˜¾ç¤ºå‡ºæ¥ï¼Œæ¨èåšæ³•ï¼š
	# - CameraController æä¾›ä¸€ä¸ªåªè¯»æ–¹æ³• get_switch_cooldown_left()
	# - æˆ–è€…æŠŠ cooldown å†™è¿› WorldStateï¼ˆç”± CameraController ä¸»åŠ¨ä¸ŠæŠ¥ï¼‰
	# state.switch_cooldown_left = 0.0

	# Day2 è°ƒè¯•ï¼šè¾“å‡ºå­—å…¸ï¼ˆä½ ç°åœ¨çœ‹åˆ°çš„ printï¼‰
	# æœªæ¥ä¸Šçº¿å‰å¯ä»¥å…³æ‰ï¼Œé¿å…åˆ·å±å½±å“æ€§èƒ½
	#print(state.to_debug_dict())

# ------------------------------------------------------------
# ä¸–ç•ŒçŠ¶æ€ï¼šå¯¹å¤–åªè¯»æ¥å£ï¼ˆDay2ï¼‰
# ------------------------------------------------------------
# è¯´æ˜ï¼š
# - DebugOverlay / UI / å½•åƒç³»ç»Ÿ ç­‰ï¼Œéƒ½é€šè¿‡è¿™ä¸ªæ¥å£æ‹¿ä¸–ç•ŒçŠ¶æ€
# - æœªæ¥è¦åšå­˜æ¡£/å›æ”¾ï¼Œä¹Ÿä¼šéå¸¸é¡º
func get_world_state() -> WorldState:
	return state
